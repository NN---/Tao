using Nemerle.Collections;
using Nemerle.Text;
using Nemerle.Utility;

using Tests.Macros;
using System;
using System.IO;
using System.Collections.Generic;
using System.Linq;

using Tao;
using Tao.Interfaces;
using Tao.Metadata;

namespace Tests
{
    public class TextSectionWriteTests
    {
        public ShouldGenerateImportAddressTable() : void
        {
            def assemblyFile = @"..\..\SampleBinaries\Skeleton.exe";
            def image = Image.ReadFrom(assemblyFile);
            def iatDirectory = image.DataDirectories[12];
            def iatRva = iatDirectory.Rva;
            def iatSize = iatDirectory.Size;
            
            // Read the actual IAT contents
            def expectedStream = image.ReadBlock(Location.ImportAddressTable);            
            def reader = BinaryReader(expectedStream);
            def nameTableRva = reader.ReadUInt32();
                        
            // Given the name table RVA, the 
            // writer should produce exactly the same output
            def actualStream = MemoryStream();
            def writer = ImportAddressTableWriter();
            writer.Write(nameTableRva, actualStream);
            
            actualStream.ShouldMatch(expectedStream);
        }
        public stub ShouldGenerateCLIHeader() : void
        {
        }
        public stub ShouldReturnCorrectSizeForCLIHeader() : void
        {
        }
        public stub ShouldWriteMethodBodyBlock() : void
        {
        }
        public stub ShouldWriteResourceSectionWhenAvailable() : void
        {
        }
        public stub ShouldWriteMetadataHeader() : void
        {
        }
        public ShouldWriteStartupStub() : void
        {
            def assemblyFile = @"..\..\SampleBinaries\Skeleton.exe";
            def image = Image.ReadFrom(assemblyFile);
            def optionalHeader = image.OptionalHeader;
            def ntHeader = optionalHeader.NTHeader :> NTHeader.[uint];
            
            // Get the ImageBase and IAT RVA from the original image
            def iatDirectory = image.DataDirectories[12];
            def iatRva = iatDirectory.Rva;
            def imageBase = ntHeader.ImageBase;
            
            // Find the entry point RVA
            def standardFields = optionalHeader.StandardFields;
            def entryPointRva = standardFields.AddressOfEntryPoint;
            
            // The standard size for the x86 stub is 6 bytes
            def entryPointLength : uint = 6;
            def expectedStream = image.ReadBlock(entryPointRva, entryPointLength);
            
            def actualStream = MemoryStream();
            def writer = StartupStubWriter();
            writer.Write(imageBase, iatRva, actualStream);
            
            actualStream.ShouldMatch(expectedStream);
        }
        public stub ShouldWriteImportHintNameTable() : void
        {
        }
        public stub ShouldGenerateCorrectHeapSizeByteFromGivenHeaps() : void
        {
        }
    }
}
