using Nemerle;
using Nemerle.Collections;
using Nemerle.Text;
using Nemerle.Utility;

using Tao;
using Tao.Interfaces;
using Tests.Macros;

using System;
using System.IO;
using System.Collections.Generic;
using System.Linq;

namespace Tests
{
    public abstract class FileBasedTableTest
    {
        private static _fileCache : Dictionary.[string, array[byte]] = Dictionary();

        protected GetTableStreamData(filename : string) : array[byte]
        {
            def getData() : array[byte]
            {
                def root = GetMetadataRoot(filename);
                root.ShouldBeNotNull("The file '{0}' is not a valid .NET assembly", TargetAssemblyFileName);

                def tableStream = root.Heaps["#~"];
                def resultStream = MemoryStream();
                tableStream.CopyTo(resultStream);

                resultStream.ToArray();
            }

            when(!_fileCache.ContainsKey(TargetAssemblyFileName))
            {
                def result = getData();
                _fileCache[TargetAssemblyFileName] = result;
            }

            _fileCache[TargetAssemblyFileName];
        }
        protected GetMetadataRoot() : IMetadataRoot
        {
            GetMetadataRoot(TargetAssemblyFileName);
        }
        protected GetMetadataRoot(filename : string) : IMetadataRoot
        {
            def bytes = File.ReadAllBytes(filename);
            def fileStream = MemoryStream(bytes);
            def imageReader = ImageReader();
            def image = imageReader.Read(fileStream);

            image.GetMetadataRoot();
        }
        protected virtual GetTableStreamData() : array[byte]
        {
            GetTableStreamData(TargetAssemblyFileName);
        }
        protected abstract TargetAssemblyFileName : string { get; }
    }
}
